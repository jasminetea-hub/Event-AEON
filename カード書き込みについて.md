# Mifareカードへの書き込みについて

## 書き込みの種類

### 1. UID（カードID）の書き込み

**通常のMifare Classicカード**: ❌ **書き込み不可**
- UIDは製造時にハードウェアで固定
- Sector 0 / Block 0 は読み取り専用で保護されている
- セキュリティ上の理由で変更不可

**Magicカード（UID変更可能なカード）**: ✅ **書き込み可能**
- 特殊なカード（例: Gen1A, Gen2, Gen3 Magic Cards）
- Sector 0 / Block 0 を直接書き換える能力がある
- 通常のMifare Classicとは異なるカード

### 2. データブロックへの書き込み

**Mifare Classic**: ✅ **書き込み可能（認証が必要）**
- Sector 1以降のデータブロックへの書き込みは可能
- 認証キー（Key A / Key B）が必要
- セキュリティ設定によって書き込みが制限される場合がある

## 現在の実装状況

現在の実装では、**UIDの読み取りのみ**を行っています：

- ✅ UID（カードID）の読み取り: 実装済み
- ❌ UIDの書き込み: 未実装（通常のカードでは不可）
- ❌ データブロックの書き込み: 未実装（実装可能）

## 書き込み機能を実装する場合

### データブロックへの書き込み（実装可能）

pcscliteを使用してデータブロックに書き込むことができます：

```javascript
// 例: Sector 1, Block 4にデータを書き込む

// 1. 認証（Key AまたはKey Bで認証）
const authCommand = Buffer.from([0xFF, 0x86, 0x00, 0x00, 0x05, ...]);
reader.transmit(authCommand, 40, protocol, (err, data) => {
  if (err || data[data.length - 1] !== 0x90) {
    console.error('認証失敗');
    return;
  }
  
  // 2. データブロックへの書き込み
  const writeCommand = Buffer.from([0xFF, 0xD6, 0x00, blockNumber, 0x10, ...data]);
  reader.transmit(writeCommand, 40, protocol, (err, data) => {
    if (err || data[data.length - 1] !== 0x90) {
      console.error('書き込み失敗');
      return;
    }
    console.log('書き込み成功');
  });
});
```

### 注意事項

1. **認証キーが必要**
   - デフォルトのKey A: `FF FF FF FF FF FF`（一部のセクター）
   - デフォルトのKey B: `FF FF FF FF FF FF`
   - カードによってはカスタムキーが設定されている場合がある

2. **セキュリティ設定の確認**
   - Access Bitsの設定によって書き込みが制限される場合がある
   - 書き込み専用セクターや読み取り専用セクターが設定されている可能性

3. **データブロックの選択**
   - Sector Trailer（Block 3, 7, 11, ...）は認証キーとアクセス設定を保存
   - データブロック（Block 0-2, 4-6, ...）にデータを書き込む

## 現在のアプリケーションでの用途

現在のアプリケーションでは：

- ✅ **UIDの読み取り**: カード識別に使用
- ✅ **データベースとの照合**: 読み取ったUIDとデータベースの`card_id`を照合
- ✅ **ユーザーIDとの照合**: カードの`user_id`とログインIDを照合

**書き込み機能は不要**（UIDをデータベースで管理しているため）

## まとめ

### 質問への回答

**Q: このカードに書き込むことは可能でしょうか？**

**A: カードの種類によります：**

1. **通常のMifare Classicカード**:
   - UIDの書き込み: ❌ 不可（読み取り専用）
   - データブロックの書き込み: ✅ 可能（認証が必要）

2. **Magicカード（UID変更可能なカード）**:
   - UIDの書き込み: ✅ 可能（特殊なコマンドが必要）
   - データブロックの書き込み: ✅ 可能

3. **現在のアプリケーション**:
   - 書き込み機能は不要（UIDを読み取ってデータベースで管理）
   - 実装可能だが、認証キーの管理が必要

## 参考情報

- Mifare Classic セクター構造: 16ブロック/セクター（Sector 0-15）
- 認証方法: ISO 14443 Type A の認証プロトコル
- 書き込みコマンド: PC/SC経由で `0xFF 0xD6` コマンドを使用
