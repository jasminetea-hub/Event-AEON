# カード照合フロー確認

## 仕様

1. カードリーダーでスキャンしたカードのUIDを取得
2. そのUIDとデータベースの`card_id`を照合
3. 一致したカードの`user_id`を取り出す
4. その`user_id`とログインIDを照合
5. 一致したら「脱出成功」を表示

## 現在の実装フロー

### ステップ1: カードリーダーでUIDを取得
**ファイル**: `server/index.js` - `readCardFromReader()`
- ICカードリーダーでカードをスキャン
- UIDを取得（`cardId`として保存）
- 例: `CB9D24AE9000`

### ステップ2: UIDとcard_idを照合
**ファイル**: `server/index.js` - `/api/read-card` (346行目)
```javascript
card = cards.find(c => c.card_id === cardId);
```
- `cards.json`から検索
- 見つからない場合、`cards.db`から検索
- `card_id === cardId`で照合

### ステップ3: 一致したカードのuser_idを取り出す
**ファイル**: `server/index.js` - `/api/read-card` (428行目)
```javascript
const cardUserId = card.user_id;
```
- データベースから取得したカードの`user_id`を取得

### ステップ4: user_idとログインIDを照合
**ファイル**: `server/index.js` - `/api/read-card` (452-460行目)
```javascript
const cardUserIdStr = String(cardUserId);
const loginUserIdStr = String(userId);

if (cardUserIdStr !== loginUserIdStr) {
  // 不一致
} else {
  // 一致 → 脱出成功
}
```

### ステップ5: 一致したら「脱出成功」を表示
**ファイル**: 
- `server/index.js` - `/api/read-card` (472-480行目): `success: true, matched: true`を返す
- `src/FinalPuzzleModal.tsx` - `readCard()` (62-70行目): レスポンスを確認して`onCorrect()`を呼び出す
- `src/Game.tsx` - `handleCardRead()` (261-269行目): `EscapeSuccessModal`を表示

## 確認結果

✅ **仕様通りに実装されています**

### フロー図

```
1. カードをスキャン
   ↓
2. UIDを取得 (例: CB9D24AE9000)
   ↓
3. データベースでcard_idを検索
   WHERE card_id = 'CB9D24AE9000'
   ↓
4. 一致したカードのuser_idを取得
   card.user_id (例: "1")
   ↓
5. user_idとログインIDを照合
   card.user_id === loginUserId
   ↓
6. 一致 → ✅ 脱出成功を表示
   不一致 → ❌ エラーメッセージを表示
```

## コードの該当箇所

### サーバー側 (`server/index.js`)

1. **UID取得** (328行目)
   ```javascript
   cardId = await readCardFromReader();
   ```

2. **card_id照合** (346行目, 386行目)
   ```javascript
   card = cards.find(c => c.card_id === cardId);
   // または
   SELECT ... FROM cards WHERE card_id = ?
   ```

3. **user_id取得** (428行目)
   ```javascript
   const cardUserId = card.user_id;
   ```

4. **ログインID照合** (452-475行目)
   ```javascript
   const cardUserIdStr = String(cardUserId);
   const loginUserIdStr = String(userId);
   if (cardUserIdStr === loginUserIdStr) {
     // 脱出成功
   }
   ```

### フロントエンド側

1. **カード読み取り** (`src/FinalPuzzleModal.tsx` - 47-85行目)
   ```typescript
   const readCard = async () => {
     const response = await fetch('/api/read-card', {
       body: JSON.stringify({ userId })
     });
     if (data.success && data.matched) {
       onCorrect(); // 脱出成功
     }
   }
   ```

2. **脱出成功表示** (`src/Game.tsx` - 261-269行目)
   ```typescript
   const handleCardRead = (cardId: string) => {
     setShowEscapeSuccessModal(true);
   }
   ```

## まとめ

✅ 仕様通りに実装されています
- UID取得 → card_id照合 → user_id取得 → ログインID照合 → 脱出成功表示

すべてのステップが正しく実装されています。
