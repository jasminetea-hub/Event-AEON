# ログインIDの照合ロジック

## 照合の流れ

### 1. カード読み取り
- ICカードリーダーでカードを読み取る
- カード番号（`cardId`）を取得
  - 例: `"CB9D24AE9000"` や `"3b8f8001804f0ca000000306030001000000006a"`

### 2. データベースからカードを検索
カード番号（`cardId`）でデータベースからカード情報を検索します。

**検索順序:**
1. `cards.json`から検索
2. 見つからない場合、テストデータベース（`cards.db`）から検索

**検索条件:**
```javascript
card.card_id === cardId
```

### 3. 照合処理

**ログインID（`userId`）と、データベースに登録されているカードの`user_id`を照合します。**

```javascript
// ログインID（アプリにログインした際に入力したID）
const loginUserId = userId;  // 例: "1", "2", "user001" など

// データベースに登録されているカードのuser_id
const cardUserId = card.user_id;  // 例: "1", "2", "user001" など

// 照合
if (cardUserId === loginUserId) {
  // ✅ 一致 → 脱出成功
} else {
  // ❌ 不一致 → エラー
}
```

## 照合の詳細

### 照合対象

| 項目 | 説明 | 例 |
|------|------|-----|
| **ログインID** | アプリにログインした際に入力したID | `"1"`, `"2"`, `"user001"` |
| **カードのuser_id** | データベースに登録されているカードの`user_id`フィールド | `"1"`, `"2"`, `"user001"` |

### 照合条件

1. **カードがデータベースに登録されている**
   - カード番号（`cardId`）でデータベースからカードを検索
   - カードが見つからない場合 → エラー

2. **カードの`user_id`が設定されている**
   - `user_id`が`null`、`undefined`、空文字列の場合 → エラー

3. **ログインIDとカードの`user_id`が一致する**
   - 文字列として比較（型の違いを考慮）
   - 一致する場合 → ✅ 脱出成功
   - 一致しない場合 → ❌ エラー

## 例

### 成功例

```
ログインID: "1"
カード番号: "CB9D24AE9000"
データベースのカード情報:
  - card_id: "CB9D24AE9000"
  - user_id: "1"

照合結果: ✅ 一致 → 脱出成功
```

### 失敗例1: user_idが設定されていない

```
ログインID: "1"
カード番号: "CB9D24AE9000"
データベースのカード情報:
  - card_id: "CB9D24AE9000"
  - user_id: null  ← 設定されていない

照合結果: ❌ "このカードにはIDが登録されていません"
```

### 失敗例2: IDが一致しない

```
ログインID: "1"
カード番号: "CB9D24AE9000"
データベースのカード情報:
  - card_id: "CB9D24AE9000"
  - user_id: "2"  ← ログインIDと異なる

照合結果: ❌ "IDが一致しません（カードのID: 2, ログインID: 1）"
```

## データベース構造

### cards.json

```json
{
  "id": 1,
  "card_id": "CB9D24AE9000",
  "user_id": "1",  ← ログインIDと照合される
  "registered_at": "2026-01-15T14:38:32.034Z",
  "notes": null
}
```

### cards.db（テストデータベース）

```sql
CREATE TABLE cards (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    card_id TEXT NOT NULL UNIQUE,
    card_type TEXT,
    user_id TEXT,  ← ログインIDと照合される
    read_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## まとめ

**ログインIDは、データベースに登録されているカードの`user_id`フィールドと照合されます。**

- カード番号（`cardId`）でカードを検索
- そのカードの`user_id`とログインID（`userId`）を比較
- 一致した場合のみ「脱出成功」が表示される
