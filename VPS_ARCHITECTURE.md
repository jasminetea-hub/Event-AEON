# VPS経由でのアーキテクチャ設計

## 概要

異なるWi-Fi環境からでも、VPSサーバーを経由してスマホアプリとカードリーダー接続端末（PC）を連携させます。

## アーキテクチャ

```
┌─────────────┐         ┌──────────────┐         ┌──────────────┐
│   スマホ    │─────────│  VPSサーバー  │─────────│   PC端末     │
│  (Wi-Fi A)  │         │ (インターネット) │         │  (Wi-Fi B)  │
│             │         │              │         │              │
│ フロントエンド│         │ フロントエンド  │         │ カードリーダー│
│            │         │ + APIサーバー │         │              │
└─────────────┘         └──────────────┘         └──────────────┘
                              │
                              │
                        ┌─────▼──────┐
                        │ データベース │
                        │ (VPS上)    │
                        └────────────┘
```

## データフロー

### 1. スマホが最後の謎を解いた時

1. スマホ → VPS: `/api/wait-for-card` にリクエスト（ポーリング）
2. VPS: カード情報待ち状態を記録

### 2. PCがカードを読み取った時

1. PC: カードリーダーでUIDを読み取り
2. PC: データベースからカードユーザーIDを取得
3. PC → VPS: `/api/submit-card` にカード情報を送信
4. VPS: カード情報を一時保存（またはデータベースに保存）

### 3. スマホがカード情報を取得

1. スマホ → VPS: `/api/get-card-info` にリクエスト（ポーリング）
2. VPS: PCから送信されたカード情報を返す
3. スマホ: カードユーザーIDとログインIDを照合
4. 一致すれば「脱出成功」を表示

## 実装の変更点

### VPSサーバー側（`server/index.js`）

1. **カード情報を受け取るエンドポイント**: `/api/submit-card`
   - PCからカード情報（cardId, cardUserId）を受信
   - 一時的にメモリまたはデータベースに保存

2. **カード情報を返すエンドポイント**: `/api/get-card-info`
   - スマホからのリクエストに対して、PCから送信されたカード情報を返す

### PC端末側（新しいスクリプト）

1. カードリーダーでカードを読み取り
2. データベースからカードユーザーIDを取得
3. VPSサーバーにカード情報を送信

### スマホ側（`FinalPuzzleModal.tsx`）

1. VPSサーバーの`/api/get-card-info`をポーリング
2. カード情報を取得してIDを照合
