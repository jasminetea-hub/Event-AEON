# VPS経由でのデプロイガイド（異なるWi-Fi環境対応）

## アーキテクチャ概要

```
┌─────────────┐         ┌──────────────┐         ┌──────────────┐
│   スマホ    │─────────│  VPSサーバー  │─────────│   PC端末     │
│  (Wi-Fi A)  │         │ (インターネット) │         │  (Wi-Fi B)  │
│             │         │              │         │              │
│ フロントエンド│         │ フロントエンド  │         │ カードリーダー│
│            │         │ + APIサーバー │         │              │
└─────────────┘         └──────────────┘         └──────────────┘
                              │
                              │
                        ┌─────▼──────┐
                        │ データベース │
                        │ (VPS上)    │
                        └────────────┘
```

## データフロー

1. **スマホ**: 最後の謎を解く → VPSサーバーの `/api/get-card-info` をポーリング
2. **PC**: カードリーダーでカードを読み取り → VPSサーバーの `/api/submit-card` に送信
3. **VPS**: カード情報を一時保存
4. **スマホ**: VPSサーバーからカード情報を取得 → IDを照合 → 「脱出成功」を表示

## セットアップ手順

### 1. VPSサーバー側のセットアップ

#### 1.1 プロジェクトのデプロイ

```bash
# VPSにSSH接続
ssh ubuntu@160.16.92.115

# リポジトリをクローン（既にクローン済みの場合はスキップ）
cd ~
git clone git@github.com:jasminetea-hub/Event-AEON.git
cd Event-AEON

# 依存関係をインストール
npm install

# フロントエンドをビルド
npm run build
```

#### 1.2 VPSサーバーを起動

```bash
# PM2をインストール（未インストールの場合）
npm install -g pm2

# バックエンドサーバーを起動
pm2 start server/index.js --name "event-aeon-server"

# フロントエンドを起動
pm2 start npm --name "event-aeon-frontend" -- run preview

# 自動起動設定
pm2 save
pm2 startup
```

#### 1.3 ファイアウォールとNginxの設定

```bash
# ポートを開放
sudo ufw allow 3000/tcp  # フロントエンド
sudo ufw allow 3001/tcp  # バックエンドAPI

# Nginxの設定（既に設定済みの場合はスキップ）
# 詳細は DEPLOY.md を参照
```

### 2. PC端末側のセットアップ

#### 2.1 プロジェクトのクローンとセットアップ

```bash
# PC端末でプロジェクトをクローン
cd ~
git clone git@github.com:jasminetea-hub/Event-AEON.git
cd Event-AEON

# 依存関係をインストール
npm install

# テストデータベースの依存関係もインストール（必要に応じて）
cd テストデータベース
npm install
cd ..
```

#### 2.2 カードリーダークライアントを起動

```bash
# VPSサーバーのURLを指定してカードリーダークライアントを起動
npm run pc:card-reader http://160.16.92.115:3001

# または、環境変数で設定
export VPS_SERVER_URL=http://160.16.92.115:3001
npm run pc:card-reader
```

### 3. スマホ側のアクセス

#### 3.1 アプリにアクセス

ブラウザで以下のURLにアクセス：
```
http://160.16.92.115:3000
```

#### 3.2 API URLの設定（自動検出）

`config.ts`により、自動的にVPSサーバーのAPI URLが設定されます。

手動で設定する場合：
```javascript
// ブラウザのコンソールで実行
localStorage.setItem('apiBaseUrl', 'http://160.16.92.115:3001');
location.reload();
```

## 使用方法

### 1. スマホでアプリを使用

1. スマホで `http://160.16.92.115:3000` にアクセス
2. ログインIDを入力してログイン
3. ゲームを進行して最後の謎を解く
4. 「を心にかざして脱出しろ！」の画面で待機

### 2. PC端末でカードを読み取り

1. PC端末でカードリーダークライアントを起動
2. ICカードをカードリーダーにかざす
3. PCが自動的にカード情報をVPSサーバーに送信

### 3. スマホで「脱出成功」が表示

1. VPSサーバー経由でカード情報がスマホに送信される
2. カードユーザーIDとログインIDが一致すれば「脱出成功」を表示

## トラブルシューティング

### PC端末からVPSサーバーに接続できない場合

```bash
# ネットワーク接続を確認
ping 160.16.92.115

# VPSサーバーのAPIにアクセスできるか確認
curl http://160.16.92.115:3001/api/submit-card
```

### スマホからVPSサーバーに接続できない場合

```bash
# スマホのブラウザでアクセスできるか確認
# http://160.16.92.115:3000

# APIエンドポイントにアクセスできるか確認
curl http://160.16.92.115:3001/api/get-card-info
```

### カード情報が送信されない場合

1. PC端末のカードリーダークライアントが正常に起動しているか確認
2. PC端末からVPSサーバーへのネットワーク接続を確認
3. VPSサーバーのログを確認: `pm2 logs event-aeon-server`

## 設定ファイル

### PC端末側の設定

`pc-terminal/card-reader-client.js` の `VPS_SERVER_URL` を変更することで、VPSサーバーのURLを設定できます。

### スマホ側の設定

`src/config.ts` により自動的にVPSサーバーのURLが設定されます。

## セキュリティに関する注意

- VPSサーバーはインターネットに公開されているため、適切な認証とセキュリティ対策を実装することを推奨します
- カード情報は一時的にメモリに保存されるため、本番環境ではRedisやデータベースを使用することを推奨します
- HTTPS（SSL/TLS）の使用を推奨します
