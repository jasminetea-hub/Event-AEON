# データベース初期化確認

## 実施した内容

✅ **データベースを初期化しました**
- `テストデータベース/cards.db`: 全カードデータを削除（0件）
- `server/cards.json`: 空の配列（既に空でした）

## データベース構造

```
cards テーブル:
- id: INTEGER PRIMARY KEY AUTOINCREMENT
- card_id: TEXT NOT NULL UNIQUE
- card_type: TEXT
- user_id: TEXT
- read_at: TIMESTAMP DEFAULT CURRENT_TIMESTAMP
- created_at: TIMESTAMP DEFAULT CURRENT_TIMESTAMP
```

## 動作確認手順

### 1. サーバーを起動

```bash
npm start
```

または

```bash
./start.sh
```

### 2. アプリケーションにログイン

1. ブラウザで `http://localhost:3000` を開く
2. ユーザーIDを入力（例: "1"）
3. ログイン

### 3. ゲームを開始

1. 「開始」ボタンをクリック
2. 各季節の謎を解く
3. 最後の謎で「おもいで」の順序にする

### 4. カードをかざす

1. カードをリーダーに近づける
2. 自動的に以下が実行されます：
   - カードのUIDを読み取る
   - データベースからカードを検索
   - **見つからない場合、自動的にデータベースに登録**
   - `user_id` = ログインID で登録
   - 登録後、`user_id`とログインIDを照合
   - 一致 → ✅ 脱出成功を表示

### 5. データベースの確認

```bash
cd "/Users/k.muto/webapp_01/テストデータベース"
sqlite3 cards.db "SELECT id, card_id, card_type, user_id, read_at FROM cards;"
```

**期待される結果:**
- カードが1件登録されている
- `card_id`: 読み取ったUID（例: `CB9D24AE9000`）
- `card_type`: `Mifare Classic`
- `user_id`: ログインID（例: `1`）

## ログの確認

サーバーログ（`server.log`）で以下を確認：

```
✅ カードをデータベースに登録しました: CB9D24AE9000
カード情報: { cardId: "CB9D24AE9000", cardType: "Mifare Classic", userId: "1" }
✅ カードのIDとログインIDが一致しました！
```

## 動作フロー

```
1. カードをかざす
   ↓
2. UIDを読み取る（例: CB9D24AE9000）
   ↓
3. データベースから検索
   ↓
4. 見つからない
   ↓
5. 自動的にデータベースに登録
   - card_id: CB9D24AE9000
   - card_type: Mifare Classic
   - user_id: 1（ログインID）
   ↓
6. 登録後、user_idとログインIDを照合
   ↓
7. 一致 → ✅ 脱出成功
```

## 確認事項

- ✅ データベースが初期化されている（0件）
- ✅ 自動登録機能が実装されている
- ✅ `user_id`がログインIDで設定される
- ✅ 登録後、照合が実行される

これで、初めてカードをかざした際も、自動的にデータベースに登録され、「脱出成功」が表示されます。
