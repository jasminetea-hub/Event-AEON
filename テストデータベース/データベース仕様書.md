# データベース仕様書

## 概要

このシステムで使用するSQLiteデータベース（`cards.db`）は、他のアプリケーションからもアクセス可能です。

## データベースファイル

- **ファイル名**: `cards.db`
- **形式**: SQLite 3
- **場所**: プロジェクトディレクトリ内（`/Users/k.muto/webapp_01/テストデータベース/cards.db`）

## テーブル構造

### cards テーブル

| カラム名 | 型 | 説明 | 制約 |
|---------|-----|------|------|
| id | INTEGER | 主キー（自動増分） | PRIMARY KEY, AUTOINCREMENT |
| card_id | TEXT | カードのID（16進数文字列） | NOT NULL, UNIQUE |
| card_type | TEXT | カードのタイプ | NULL可 |
| read_at | TIMESTAMP | 読み取り日時 | DEFAULT CURRENT_TIMESTAMP |
| created_at | TIMESTAMP | 登録日時 | DEFAULT CURRENT_TIMESTAMP |

### インデックス

- `idx_card_id`: `card_id`カラムにインデックスが作成されています

## SQLスキーマ

```sql
CREATE TABLE IF NOT EXISTS cards (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    card_id TEXT NOT NULL UNIQUE,
    card_type TEXT,
    read_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_card_id ON cards(card_id);
```

## 他のアプリケーションからのアクセス方法

### Python

```python
import sqlite3

# データベースに接続
conn = sqlite3.connect('cards.db')
cursor = conn.cursor()

# すべてのカードを取得
cursor.execute('SELECT * FROM cards ORDER BY read_at DESC')
cards = cursor.fetchall()

for card in cards:
    print(f"ID: {card[0]}, カード番号: {card[1]}, タイプ: {card[2]}")

conn.close()
```

### Node.js

```javascript
const sqlite3 = require('sqlite3').verbose();

const db = new sqlite3.Database('cards.db');

db.all('SELECT * FROM cards ORDER BY read_at DESC', (err, rows) => {
    if (err) {
        console.error(err);
        return;
    }
    rows.forEach(row => {
        console.log(`ID: ${row.id}, カード番号: ${row.card_id}, タイプ: ${row.card_type}`);
    });
});

db.close();
```

### Java

```java
import java.sql.*;

public class CardDatabase {
    public static void main(String[] args) {
        try {
            Class.forName("org.sqlite.JDBC");
            Connection conn = DriverManager.getConnection("jdbc:sqlite:cards.db");
            
            Statement stmt = conn.createStatement();
            ResultSet rs = stmt.executeQuery("SELECT * FROM cards ORDER BY read_at DESC");
            
            while (rs.next()) {
                System.out.println("ID: " + rs.getInt("id") + 
                                 ", カード番号: " + rs.getString("card_id") +
                                 ", タイプ: " + rs.getString("card_type"));
            }
            
            conn.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

### C#

```csharp
using System;
using System.Data.SQLite;

class Program {
    static void Main() {
        using (var connection = new SQLiteConnection("Data Source=cards.db")) {
            connection.Open();
            
            var command = new SQLiteCommand("SELECT * FROM cards ORDER BY read_at DESC", connection);
            var reader = command.ExecuteReader();
            
            while (reader.Read()) {
                Console.WriteLine($"ID: {reader["id"]}, カード番号: {reader["card_id"]}, タイプ: {reader["card_type"]}");
            }
        }
    }
}
```

### Excel / Google Sheets

1. **Excel**: 
   - データ > データの取得 > データベースから > SQL Server データベースから
   - または、SQLite用のODBCドライバーを使用

2. **Google Sheets**:
   - Apps Scriptを使用してSQLiteデータベースに接続（外部サービス経由）

## 注意事項

### 同時アクセス

- SQLiteは複数の読み取りアクセスをサポートしています
- 複数のアプリケーションが同時に書き込む場合は、データベースロックが発生する可能性があります
- 書き込み操作は順次実行されるため、同時書き込みは避けてください

### データベースファイルの場所

- データベースファイルはプロジェクトディレクトリ内にあります
- 他のアプリケーションからアクセスする場合は、絶対パスまたは相対パスを指定してください

### バックアップ

- 定期的にデータベースファイルをバックアップすることを推奨します
- SQLiteデータベースは単一ファイルなので、ファイルをコピーするだけでバックアップできます

## データの例

```sql
-- カードを挿入
INSERT INTO cards (card_id, card_type) VALUES ('CB9D24AE9000', 'Mifare Classic');

-- すべてのカードを取得
SELECT * FROM cards;

-- 特定のカードを検索
SELECT * FROM cards WHERE card_id = 'CB9D24AE9000';

-- カード数を取得
SELECT COUNT(*) FROM cards;

-- 最新の10件を取得
SELECT * FROM cards ORDER BY read_at DESC LIMIT 10;
```

## データベースビューアー

以下のツールを使用してデータベースを閲覧・編集できます：

- **DB Browser for SQLite** (https://sqlitebrowser.org/)
- **DBeaver** (https://dbeaver.io/)
- **TablePlus** (https://tableplus.com/)
- **VS Code拡張機能**: SQLite Viewer

## データベースの移行

他のデータベース（MySQL、PostgreSQLなど）に移行する場合は、以下のSQLを実行してください：

```sql
-- MySQL/PostgreSQL用のスキーマ
CREATE TABLE cards (
    id SERIAL PRIMARY KEY,
    card_id VARCHAR(255) NOT NULL UNIQUE,
    card_type VARCHAR(50),
    read_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_card_id ON cards(card_id);
```
