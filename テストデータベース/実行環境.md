# 実行環境情報

このシステムが正常に動作した時の環境情報をまとめています。

## オペレーティングシステム

- **OS**: macOS
- **バージョン**: 26.2 (Sequoia)
- **ビルド**: 25C56
- **アーキテクチャ**: ARM64 (Apple Silicon)

## Node.js環境

- **Node.jsバージョン**: v24.12.0
- **npmバージョン**: 11.6.2
- **インストール方法**: Homebrew経由

## インストール済みパッケージ

### Node.jsパッケージ（プロジェクト内）

```json
{
  "dependencies": {
    "pcsclite": "^1.0.0",
    "sqlite3": "^5.1.6"
  }
}
```

### システムライブラリ（Homebrew経由）

以下のライブラリがHomebrewでインストールされています：

- **pcsc-lite**: PC/SCサービス（カードリーダー通信）
- **libusb**: USBデバイスアクセス
- **libusb-compat**: libusb互換性ライブラリ
- **libnfc**: NFC機能ライブラリ

### インストールコマンド

```bash
# PC/SCライブラリ
brew install pcsc-lite

# USBデバイスアクセス
brew install libusb

# NFC機能（参考用、Node.js版では直接使用しない）
brew install libnfc
```

## ハードウェア

### カードリーダー

- **デバイス名**: SONY FeliCa Port/PaSoRi 4.0
- **接続方式**: USB
- **ベンダーID**: 0x054c (SONY)
- **製品ID**: 0x0dc9
- **検出方法**: PC/SC経由で自動検出

### カードタイプ

- **Mifare Classic**: 正常に読み取り可能
- **FeliCa**: 対応可能（PaSoRiはFeliCaリーダー）

## システム設定

### セキュリティとプライバシー設定

以下の設定が有効になっています：

1. **完全なディスクアクセス**
   - ターミナルアプリ（Terminal.app）にチェックが入っている
   - これにより、npmやNode.jsがシステムファイルにアクセス可能

2. **ファイルとフォルダへのアクセス**
   - ターミナルが「ダウンロードフォルダ」と「書類フォルダ」にアクセス可能

### PC/SCサービス

- **サービス名**: pcsc-lite
- **状態**: 起動中（自動起動）
- **確認コマンド**: `brew services list | grep pcsc`

## プロジェクト構成

### ディレクトリ構造

```
/Users/k.muto/webapp_01/テストデータベース/
├── main.js                    # メインアプリケーション
├── card_reader.js             # カード読み取り機能
├── database.js                # データベース操作機能
├── package.json               # Node.jsパッケージ設定
├── package-lock.json          # パッケージロックファイル
├── node_modules/              # インストール済みパッケージ
│   ├── pcsclite/              # PC/SCライブラリ
│   └── sqlite3/               # SQLite3ライブラリ
├── cards.db                   # SQLiteデータベース（自動生成）
└── README.md                  # 使用方法
```

### データベース

- **ファイル名**: `cards.db`
- **形式**: SQLite 3
- **場所**: `/Users/k.muto/webapp_01/テストデータベース/cards.db`
- **テーブル**: `cards`（自動作成）

## 動作確認済みの機能

### 正常に動作する機能

1. ✅ **PaSoRiリーダーの検出**
   - PC/SCサービス経由で自動検出
   - リーダー名: "SONY FeliCa Port/PaSoRi 4.0"

2. ✅ **Mifareカードの検出**
   - カードをリーダーに近づけると自動検出
   - `status`イベントで検出

3. ✅ **カードIDの読み取り**
   - ATR（Answer To Reset）の取得
   - UID（カードID）の取得
   - 例: `CB9D24AE9000`

4. ✅ **データベースへの保存**
   - SQLiteデータベースに自動保存
   - 重複チェック機能

5. ✅ **カード一覧の表示**
   - データベース内の全カードを表示
   - 読み取り日時でソート

## 実行コマンド

### アプリケーションの起動

```bash
# プロジェクトディレクトリに移動
cd "/Users/k.muto/webapp_01/テストデータベース"

# アプリケーションを起動
npm start

# または
node main.js
```

### パッケージのインストール

```bash
# 初回セットアップ時
npm install
```

### PC/SCサービスの確認

```bash
# サービス状態の確認
brew services list | grep pcsc

# サービスを起動（必要に応じて）
brew services start pcsc-lite
```

## 環境変数

特に設定が必要な環境変数はありませんが、以下の環境変数が設定されている場合があります：

- `DYLD_LIBRARY_PATH`: ライブラリの検索パス（通常は不要）
- `PATH`: Node.jsとnpmのパスが含まれている

## トラブルシューティング時の確認事項

### 1. Node.jsとnpmのバージョン確認

```bash
node --version  # v24.12.0
npm --version   # 11.6.2
```

### 2. パッケージのインストール確認

```bash
cd "/Users/k.muto/webapp_01/テストデータベース"
ls node_modules/ | grep -E "(pcsclite|sqlite3)"
```

### 3. PC/SCサービスの確認

```bash
brew services list | grep pcsc
# pcsc-lite started と表示されていれば正常
```

### 4. リーダーの検出確認

```bash
# システムでリーダーが検出されているか確認
system_profiler SPUSBDataType | grep -i "sony\|pasori\|felica"
```

### 5. 権限設定の確認

- システム環境設定 > セキュリティとプライバシー > プライバシー
- 「完全なディスクアクセス」にターミナルアプリが追加されているか確認

## 動作確認済みのテストケース

### テスト1: カードの1回読み取り

1. アプリケーションを起動
2. メニューで「1」を選択
3. Mifareカードをリーダーに近づける
4. カードIDが表示され、データベースに保存される

**結果**: ✅ 成功
- カードID: `CB9D24AE9000`
- カードタイプ: `Mifare Classic`
- ATR: `3B8F8001804F0CA000000306030001000000006A`

### テスト2: データベースへの保存

1. カードを読み取る
2. メニューで「3」を選択（カード一覧表示）
3. 読み取ったカードが一覧に表示される

**結果**: ✅ 成功
- データベースに正常に保存される
- 一覧表示で確認可能

### テスト3: 重複チェック

1. 同じカードを2回読み取る
2. 2回目は「既にデータベースに存在します」と表示される

**結果**: ✅ 成功
- 重複が正しく検出される

## 既知の制限事項

1. **同時書き込み**: 複数のアプリケーションが同時にデータベースに書き込む場合は、ロックが発生する可能性があります
2. **カードタイプ**: 現在はMifare Classicに最適化されていますが、FeliCaカードも読み取り可能です
3. **macOSバージョン**: macOS Sequoia (26.2) で動作確認済み。他のバージョンでも動作する可能性が高いです

## パフォーマンス

- **カード検出時間**: 約1-2秒
- **データベース保存時間**: 数ミリ秒
- **メモリ使用量**: 約50-100MB（Node.jsプロセス）

## まとめ

このシステムは以下の環境で正常に動作することが確認されています：

- **OS**: macOS Sequoia 26.2
- **Node.js**: v24.12.0
- **リーダー**: PaSoRi 4.0
- **カード**: Mifare Classic

同じ環境を再現する場合は、上記の情報を参考にセットアップしてください。
