# カード設定手順

## 問題

「脱出成功」が表示されない場合、以下の原因が考えられます：

1. **カードが検出されていない**
2. **カードに`user_id`が設定されていない**

## 解決方法

### 1. カードに`user_id`を設定する

カードを読み取った後、そのカードの`user_id`をログインIDと同じ値に設定する必要があります。

#### 方法A: `cards.json`に直接設定

```bash
# cards.jsonを編集
# 例: ログインIDが"1"の場合
{
  "id": 1,
  "card_id": "3b8f8001804f0ca000000306030001000000006a",
  "user_id": "1",  // ← ログインIDと同じ値に設定
  "registered_at": "2026-01-15T14:38:32.034Z",
  "notes": null
}
```

#### 方法B: テストデータベース（`cards.db`）に設定

```bash
cd "/Users/k.muto/webapp_01/テストデータベース"

# カードのuser_idを更新
# 例: カードIDが"CB9D24AE9000"で、ログインIDが"1"の場合
sqlite3 cards.db "UPDATE cards SET user_id = '1' WHERE card_id = 'CB9D24AE9000';"

# 確認
sqlite3 cards.db "SELECT id, card_id, user_id FROM cards WHERE card_id = 'CB9D24AE9000';"
```

#### 方法C: テストデータベースアプリで設定

```bash
cd "/Users/k.muto/webapp_01/テストデータベース"
npm start

# メニューから「1. カードを1回読み取る」を選択
# カードをかざす
# ユーザーIDを入力（ログインIDと同じ値）
```

### 2. カードが検出されない場合

1. **ICカードリーダーが接続されているか確認**
2. **PC/SCサービスが起動しているか確認**
   ```bash
   brew services list | grep pcsc
   # 起動していない場合
   brew services start pcsc-lite
   ```
3. **カードをリーダーに近づける**
   - 最後の謎で「おもいで」の順序になったら、自動的にICカードリーダーが起動します
   - カードをリーダーに近づけてください

### 3. デバッグ方法

ブラウザのコンソール（F12）で以下のログを確認：

```
カード読み取りレスポンス: { success: true/false, matched: true/false, ... }
✅ 脱出成功！カードID: ...
❌ カード読み取り失敗: ...
```

サーバーのログ（`server.log`）で以下を確認：

```
カード読み取り成功: ...
現在のユーザーID: ...
カード情報: { cardId: ..., userId: ..., loginUserId: ... }
✅ カード番号とIDが一致しました！
```

## 確認事項

1. **ログインID**: アプリにログインした際のID（例: "1", "2"など）
2. **カードの`user_id`**: データベースに登録されているカードの`user_id`がログインIDと同じか
3. **カード番号**: カードリーダーで読み取ったカード番号がデータベースに登録されているか

## 例

ログインIDが"1"の場合：

1. カードを読み取る（カード番号: "CB9D24AE9000"）
2. データベースでカードを検索
3. そのカードの`user_id`を"1"に設定
4. アプリでカードをかざす
5. 「脱出成功」が表示される
